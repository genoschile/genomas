generator client {
  provider = "prisma-client"
  output   = "../../../node_modules/@prisma/client"
}

datasource db {
  provider = "postgresql"
}

model License {
  id             String        @id @default(cuid())
  licenseType    LicenseType
  licenseScope   LicenseScope
  maxUsers       Int
  assignedUsers  Int           @default(0)
  startDate      DateTime
  endDate        DateTime
  isActive       Boolean       @default(true)
  userId         String?       @unique
  organizationId String?       @unique
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  organization   Organization? @relation(fields: [organizationId], references: [id])
  user           User?         @relation(fields: [userId], references: [id])
}

model Organization {
  id         String      @id @default(cuid())
  name       String
  createdAt  DateTime    @default(now())
  domain     String?
  email      String      @unique
  isActive   Boolean     @default(true)
  logoUrl    String?
  password   String
  updatedAt  DateTime    @updatedAt
  groups     Group[]
  license    License?
  users      User[]
  workspaces Workspace[]
}

model Group {
  id             String              @id @default(cuid())
  name           String
  role           Role[]
  organizationId String
  createdAt      DateTime            @default(now())
  description    String?
  isActive       Boolean             @default(true)
  updatedAt      DateTime            @updatedAt
  organization   Organization        @relation(fields: [organizationId], references: [id])
  projectShares  ProjectGroupShare[] @relation("GroupProjectShares")
  UserGroup      UserGroup[]
  users          User[]              @relation("UserGroups")
}

model UserGroup {
  userId    String
  groupId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  group     Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, groupId])
}

model User {
  id                String            @id @default(cuid())
  name              String?
  email             String            @unique
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  encryptedPassword String
  userType          UserType          @default(CLIENT)
  organizationId    String
  isDefaultAdmin    Boolean           @default(false)
  File              File[]
  license           License?
  PipelineRun       PipelineRun[]
  sharedProjects    ProjectShare[]
  Sample            Sample[]
  organization      Organization      @relation(fields: [organizationId], references: [id])
  UserGroup         UserGroup[]
  workspaceMembers  WorkspaceMember[]
  groups            Group[]           @relation("UserGroups")
}

model Workspace {
  id             String            @id @default(cuid())
  name           String
  pipelineType   PipelineType
  organizationId String?
  updatedAt      DateTime          @updatedAt
  createdAt      DateTime          @default(now())
  description    String?
  isActive       Boolean           @default(true)
  projects       Project[]
  organization   Organization?     @relation(fields: [organizationId], references: [id])
  members        WorkspaceMember[]
}

model WorkspaceMember {
  id          String    @id @default(cuid())
  userId      String
  workspaceId String
  role        Role
  assignedAt  DateTime  @default(now())
  isActive    Boolean   @default(true)
  updatedAt   DateTime  @updatedAt
  user        User      @relation(fields: [userId], references: [id])
  workspace   Workspace @relation(fields: [workspaceId], references: [id])

  @@unique([userId, workspaceId])
}

model Project {
  id               String              @id @default(cuid())
  name             String
  description      String?
  workspaceId      String
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @default(now())
  Files            File[]
  executions       PipelineRun[]
  workspace        Workspace           @relation(fields: [workspaceId], references: [id])
  sharedWithGroups ProjectGroupShare[] @relation("ProjectGroupShares")
  sharedWith       ProjectShare[]
}

model ProjectShare {
  id        String     @id @default(cuid())
  userId    String
  projectId String
  access    AccessType
  createdAt DateTime   @default(now())
  project   Project    @relation(fields: [projectId], references: [id])
  user      User       @relation(fields: [userId], references: [id])

  @@unique([userId, projectId])
}

model ProjectGroupShare {
  id        String     @id @default(cuid())
  groupId   String
  projectId String
  access    AccessType
  createdAt DateTime   @default(now())
  group     Group      @relation("GroupProjectShares", fields: [groupId], references: [id])
  project   Project    @relation("ProjectGroupShares", fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([groupId, projectId])
}

model File {
  id            String        @id @default(cuid())
  filename      String
  path          String
  fileType      FileType
  fileRole      FileRole
  uploadedAt    DateTime      @default(now())
  projectId     String
  sampleId      Int?
  pipelineRunId String?
  inputForRunId String?
  outputOfRunId String?
  createdById   String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  documentTags  DocumentTag[]
  createdBy     User?         @relation(fields: [createdById], references: [id])
  inputForRun   PipelineRun?  @relation("InputFiles", fields: [inputForRunId], references: [id])
  outputOfRun   PipelineRun?  @relation("OutputFiles", fields: [outputOfRunId], references: [id])
  pipelineRun   PipelineRun?  @relation("PipelineRunLink", fields: [pipelineRunId], references: [id])
  project       Project       @relation(fields: [projectId], references: [id])
  sample        Sample?       @relation(fields: [sampleId], references: [id])
}

model PipelineRun {
  id            String    @id @default(cuid())
  startedAt     DateTime
  endedAt       DateTime?
  status        RunStatus
  workflow      String
  projectId     String
  createdAt     DateTime  @default(now())
  createdById   String?
  description   String?
  name          String?
  updatedAt     DateTime  @updatedAt
  inputFiles    File[]    @relation("InputFiles")
  outputFiles   File[]    @relation("OutputFiles")
  pipelineFiles File[]    @relation("PipelineRunLink")
  createdBy     User?     @relation(fields: [createdById], references: [id])
  project       Project   @relation(fields: [projectId], references: [id])
}

model Sample {
  id             Int          @id @default(autoincrement())
  sampleName     String
  reportDate     DateTime
  sampleType     InputSource
  sequencingType SequenceType
  disease        String
  folioNumber    Int
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  createdById    String?
  genomicFiles   File[]
  createdBy      User?        @relation(fields: [createdById], references: [id])
}

model Tag {
  id        String        @id @default(cuid())
  name      String
  type      TagType
  documents DocumentTag[]
}

model DocumentTag {
  id     String @id @default(cuid())
  tagId  String
  fileId String
  file   File   @relation(fields: [fileId], references: [id])
  tag    Tag    @relation(fields: [tagId], references: [id])
}

enum UserType {
  ADMIN
  CLIENT
}

enum Role {
  OWNER
  ADMIN
  EDITOR
  VIEWER
}

enum PipelineType {
  CANCER
  GERMLINE
  BACTERIA
}

enum InputSource {
  SOMATIC
  GERMINAL
  LIQUID_BIOPSY
  CLINICAL
}

enum SequenceType {
  WHOLE_GENOME
  WHOLE_EXOME
  GENOMIC_PANEL
}

enum FileType {
  FASTQ
  BAM
  VCF
  MAF
  CSV
  PDF
}

enum FileRole {
  INPUT
  OUTPUT
  INTERMEDIATE
  FINAL_REPORT
}

enum RunStatus {
  RUNNING
  DONE
  FAILED
  PENDING
}

enum AccessType {
  VIEW
  EDIT
  ADMIN
}

enum LicenseType {
  INDIVIDUAL
  SMALL_TEAM
  ORGANIZATION
}

enum LicenseScope {
  USER
  ORGANIZATION
}

enum TagType {
  SAMPLE
  CATEGORY
  FILETYPE
  DISEASE
  CUSTOM
  ANALYSIS_STAGE
  QUALITY_FLAG
  PRIORITY
}
