// workspace => acumulación de project
// cada uno de esos user tiene por default su propio workspace aloja project y lo que es invitado, que cada project tendrá un creador
// ahora tenemos workspace y project 
// licencia tabla licencia tipos licencia (perpetua-anual) expiración
// ind para un numero determinado de pacientes x user mensual, por un numero dado de usuarios anual, ilimitada de pacientes
//usuarios con accesos agregar

// fastq bam fastqgz

// documento => tags (BAM)
// DOCUMENTO => ID TAGS (AUTOINCREMENTAL UNICO 1 !== ID)
// OTRA TABLA QUE HAGA ASOCIAC CON SAMPLE
// EDAD SEXO ENFERMEDAD 
//

// Modelos principales

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserType {
  ADMIN
  CLIENT
}

enum Role {
  OWNER
  ADMIN
  EDITOR
  VIEWER
}

enum PipelineType {
  CANCER
  GERMLINE
  BACTERIA
}

enum InputSource {
  SOMATIC
  GERMINAL
  LIQUID_BIOPSY
  CLINICAL
}

enum SequenceType {
  WHOLE_GENOME
  WHOLE_EXOME
  GENOMIC_PANEL
}

enum FileType {
  FASTQ
  BAM
  VCF
  MAF
  CSV
  PDF
}

enum FileRole {
  INPUT
  OUTPUT
  INTERMEDIATE
  FINAL_REPORT
}

enum RunStatus {
  RUNNING
  DONE
  FAILED
  PENDING
}

enum AccessType {
  VIEW
  EDIT
  ADMIN
}

enum LicenseType {
  INDIVIDUAL
  SMALL_TEAM
  ORGANIZATION
}

enum LicenseScope {
  USER
  ORGANIZATION
}

enum TagType {
  SAMPLE
  CATEGORY
  FILETYPE
  DISEASE
  CUSTOM
  ANALYSIS_STAGE
  QUALITY_FLAG
  PRIORITY
}

// Licencias
model License {
  id            String       @id @default(cuid())
  licenseType   LicenseType
  licenseScope  LicenseScope
  maxUsers      Int
  assignedUsers Int          @default(0)
  startDate     DateTime
  endDate       DateTime
  isActive      Boolean      @default(true)

  user   User?   @relation(fields: [userId], references: [id])
  userId String? @unique

  organization   Organization? @relation(fields: [organizationId], references: [id])
  organizationId String?       @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Organización
model Organization {
  id         String      @id @default(cuid())
  name       String
  users      User[]
  workspaces Workspace[]
  license    License?
}

// Usuario
model User {
  id                String            @id @default(cuid())
  email             String            @unique
  name              String?
  encryptedPassword String
  userType          UserType          @default(CLIENT)
  organizationId    String
  organization      Organization      @relation(fields: [organizationId], references: [id])
  groupId           String?
  group             Group?            @relation(fields: [groupId], references: [id])
  workspacesOwned   Workspace[]       @relation("OwnedWorkspaces")
  workspaceMembers  WorkspaceMember[]
  sharedProjects    ProjectShare[]
  ownedProjects     Project[]
  license           License?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
}

// Grupos con roles
model Group {
  id    String @id @default(cuid())
  name  String
  role  Role
  users User[]
}

// Workspace
model Workspace {
  id             String            @id @default(cuid())
  name           String
  pipelineType   PipelineType
  organizationId String?
  organization   Organization?     @relation(fields: [organizationId], references: [id])
  ownerId        String
  owner          User              @relation("OwnedWorkspaces", fields: [ownerId], references: [id])
  projects       Project[]
  members        WorkspaceMember[]
}

// Relación usuario - workspace (acceso)
model WorkspaceMember {
  id          String @id @default(cuid())
  userId      String
  workspaceId String
  role        Role

  user      User      @relation(fields: [userId], references: [id])
  workspace Workspace @relation(fields: [workspaceId], references: [id])

  @@unique([userId, workspaceId]) // Evita duplicados
}

// Proyecto
model Project {
  id          String         @id @default(cuid())
  name        String
  description String?
  workspaceId String
  workspace   Workspace      @relation(fields: [workspaceId], references: [id])
  ownerId     String
  owner       User           @relation(fields: [ownerId], references: [id])
  sharedWith  ProjectShare[]
  inputFiles  GenomicFile[]
  executions  PipelineRun[]
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @default(now())
}

// Compartir proyecto con otros usuarios
model ProjectShare {
  id        String     @id @default(cuid())
  userId    String
  projectId String
  access    AccessType

  user    User    @relation(fields: [userId], references: [id])
  project Project @relation(fields: [projectId], references: [id])

  @@unique([userId, projectId]) // Evita compartir duplicado
}

// Archivos genómicos
model GenomicFile {
  id         String   @id @default(cuid())
  filename   String
  path       String
  fileType   FileType
  fileRole   FileRole
  project    Project  @relation(fields: [projectId], references: [id])
  projectId  String
  sampleId   Int?
  sample     Sample?  @relation(fields: [sampleId], references: [id])
  uploadedAt DateTime @default(now())

  pipelineRun   PipelineRun? @relation("PipelineRunLink", fields: [pipelineRunId], references: [id])
  pipelineRunId String?

  inputForRun   PipelineRun? @relation("InputFiles", fields: [inputForRunId], references: [id])
  inputForRunId String?

  outputOfRun   PipelineRun? @relation("OutputFiles", fields: [outputOfRunId], references: [id])
  outputOfRunId String?

  documentTags DocumentTag[]
}

model PipelineRun {
  id          String        @id @default(cuid())
  startedAt   DateTime
  endedAt     DateTime?
  status      RunStatus
  workflow    String
  inputFiles  GenomicFile[] @relation("InputFiles")
  outputFiles GenomicFile[] @relation("OutputFiles")
  project     Project       @relation(fields: [projectId], references: [id])
  projectId   String

  pipelineFiles GenomicFile[] @relation("PipelineRunLink")
}

// Datos genómicos
model Sample {
  id             Int           @id @default(autoincrement())
  sampleName     String
  reportDate     DateTime
  sampleType     InputSource
  sequencingType SequenceType
  disease        String
  folioNumber    Int
  genes          Gene[]
  genomicFiles   GenomicFile[] // Relación inversa
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
}

model Gene {
  id               Int                     @id @default(autoincrement())
  types            String[]
  impacts          String[]
  significances    String[]
  description      String
  sampleId         Int
  sample           Sample                  @relation(fields: [sampleId], references: [id])
  variants         Variant[]
  activePrinciples ActivePrincipleOnGene[]
}

model Variant {
  id     Int    @id @default(autoincrement())
  name   String
  geneId Int
  gene   Gene   @relation(fields: [geneId], references: [id])
}

model ActivePrinciple {
  id                     Int                     @id @default(autoincrement())
  name                   String
  availabilityInChile    Boolean
  enterprise             String?
  pharmaceutical         String?
  activePrinciplesOnGene ActivePrincipleOnGene[]
}

model ActivePrincipleOnGene {
  id                Int             @id @default(autoincrement())
  gene              Gene            @relation(fields: [geneId], references: [id])
  geneId            Int
  activePrinciple   ActivePrinciple @relation(fields: [activePrincipleId], references: [id])
  activePrincipleId Int
}

// Sistema de tags
model Tag {
  id        String        @id @default(cuid())
  name      String
  type      TagType
  documents DocumentTag[]
}

model DocumentTag {
  id     String      @id @default(cuid())
  file   GenomicFile @relation(fields: [fileId], references: [id])
  fileId String
  tag    Tag         @relation(fields: [tagId], references: [id])
  tagId  String
}
