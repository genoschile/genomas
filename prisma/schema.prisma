generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserType {
  ADMIN
  CLIENT
}

enum Role {
  OWNER
  ADMIN
  EDITOR
  VIEWER
}

enum PipelineType {
  CANCER
  GERMLINE
  BACTERIA
}

enum InputSource {
  SOMATIC
  GERMINAL
  LIQUID_BIOPSY
  CLINICAL
}

enum SequenceType {
  WHOLE_GENOME
  WHOLE_EXOME
  GENOMIC_PANEL
}

enum FileType {
  FASTQ
  BAM
  VCF
  MAF
  CSV
  PDF
}

enum FileRole {
  INPUT
  OUTPUT
  INTERMEDIATE
  FINAL_REPORT
}

enum RunStatus {
  RUNNING
  DONE
  FAILED
  PENDING
}

enum AccessType {
  VIEW
  EDIT
  ADMIN
}

enum LicenseType {
  INDIVIDUAL
  SMALL_TEAM
  ORGANIZATION
}

enum LicenseScope {
  USER
  ORGANIZATION
}

enum TagType {
  SAMPLE
  CATEGORY
  FILETYPE
  DISEASE
  CUSTOM
  ANALYSIS_STAGE
  QUALITY_FLAG
  PRIORITY
}

// Licencias
model License {
  id            String       @id @default(cuid())
  licenseType   LicenseType
  licenseScope  LicenseScope
  maxUsers      Int
  assignedUsers Int          @default(0)
  startDate     DateTime
  endDate       DateTime
  isActive      Boolean      @default(true)

  user   User?   @relation(fields: [userId], references: [id])
  userId String? @unique

  organization   Organization? @relation(fields: [organizationId], references: [id])
  organizationId String?       @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Organizaci贸n
model Organization {
  id         String      @id @default(cuid())
  name       String
  email      String      @unique
  password   String
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  isActive   Boolean     @default(true)
  users      User[]
  workspaces Workspace[]
  license    License?
  logoUrl    String?
  domain     String?

  groups Group[]
}

model Group {
  id   String @id @default(cuid())
  name String
  role Role[]

  users User[] @relation("UserGroups")

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  projectShares ProjectGroupShare[] @relation("GroupProjectShares")

  description String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  isActive    Boolean     @default(true)
  UserGroup   UserGroup[]
}

model UserGroup {
  userId  String
  groupId String

  user  User  @relation(fields: [userId], references: [id])
  group Group @relation(fields: [groupId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@id([userId, groupId]) // Clave primaria compuesta evita duplicados
}

model User {
  id String @id @default(cuid())

  isDefaultAdmin Boolean @default(false)

  email             String       @unique
  name              String?
  encryptedPassword String
  userType          UserType     @default(CLIENT)
  organizationId    String
  organization      Organization @relation(fields: [organizationId], references: [id])

  groups Group[] @relation("UserGroups")

  workspaceMembers WorkspaceMember[]
  sharedProjects   ProjectShare[]
  license          License?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  File             File[]
  PipelineRun      PipelineRun[]
  Sample           Sample[]
  UserGroup        UserGroup[]
}

// Workspace
model Workspace {
  id           String       @id @default(cuid())
  name         String
  pipelineType PipelineType

  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt()
  isActive    Boolean  @default(true)

  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  projects Project[]
  members  WorkspaceMember[]
}

// Relaci贸n usuario - workspace (acceso)
model WorkspaceMember {
  id          String @id @default(cuid())
  userId      String
  workspaceId String
  role        Role

  assignedAt DateTime @default(now())
  updatedAt  DateTime @updatedAt
  isActive   Boolean  @default(true)

  user      User      @relation(fields: [userId], references: [id])
  workspace Workspace @relation(fields: [workspaceId], references: [id])

  @@unique([userId, workspaceId]) // Evita duplicados
}

// Proyecto
model Project {
  id          String    @id @default(cuid())
  name        String
  description String?
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id])

  sharedWith       ProjectShare[]
  sharedWithGroups ProjectGroupShare[] @relation("ProjectGroupShares")

  Files      File[]
  executions PipelineRun[]
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @default(now())
}

// Compartir proyecto con otros usuarios
model ProjectShare {
  id        String     @id @default(cuid())
  userId    String
  projectId String
  access    AccessType

  user    User    @relation(fields: [userId], references: [id])
  project Project @relation(fields: [projectId], references: [id])

  createdAt DateTime @default(now())

  @@unique([userId, projectId])
}

// Compartir proyecto con grupos
model ProjectGroupShare {
  id        String     @id @default(cuid())
  groupId   String
  projectId String
  access    AccessType

  group   Group   @relation(fields: [groupId], references: [id], name: "GroupProjectShares")
  project Project @relation(fields: [projectId], references: [id], name: "ProjectGroupShares")

  createdAt DateTime @default(now())

  @@unique([groupId, projectId])
}

// Archivos gen贸micos
model File {
  id         String   @id @default(cuid())
  filename   String
  path       String
  fileType   FileType
  fileRole   FileRole
  uploadedAt DateTime @default(now())
  projectId  String
  project    Project  @relation(fields: [projectId], references: [id])
  sampleId   Int?
  sample     Sample?  @relation(fields: [sampleId], references: [id])

  pipelineRunId String?
  pipelineRun   PipelineRun? @relation("PipelineRunLink", fields: [pipelineRunId], references: [id])
  inputForRunId String?
  inputForRun   PipelineRun? @relation("InputFiles", fields: [inputForRunId], references: [id])
  outputOfRunId String?
  outputOfRun   PipelineRun? @relation("OutputFiles", fields: [outputOfRunId], references: [id])

  createdById String?
  createdBy   User?    @relation(fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  documentTags DocumentTag[]
}

model PipelineRun {
  id          String    @id @default(cuid())
  startedAt   DateTime
  endedAt     DateTime?
  status      RunStatus
  workflow    String
  name        String? // Ej. "Run HG-001 - Tumor"
  description String? // Para contexto adicional
  projectId   String
  project     Project   @relation(fields: [projectId], references: [id])

  inputFiles    File[] @relation("InputFiles")
  outputFiles   File[] @relation("OutputFiles")
  pipelineFiles File[] @relation("PipelineRunLink")

  createdById String?
  createdBy   User?    @relation(fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Datos gen贸micos
model Sample {
  id             Int          @id @default(autoincrement())
  sampleName     String
  reportDate     DateTime
  sampleType     InputSource
  sequencingType SequenceType
  disease        String
  folioNumber    Int
  genomicFiles   File[]

  createdById String?
  createdBy   User?    @relation(fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Sistema de tags
model Tag {
  id        String        @id @default(cuid())
  name      String
  type      TagType
  documents DocumentTag[]
}

model DocumentTag {
  id     String @id @default(cuid())
  file   File   @relation(fields: [fileId], references: [id])
  fileId String
  tag    Tag    @relation(fields: [tagId], references: [id])
  tagId  String
}
